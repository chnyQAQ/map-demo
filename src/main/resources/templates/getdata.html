<!DOCTYPE html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <title>加载数据</title>
</head>
<body>
<div id="map-canvas"></div>
<script th:src="@{/webjars/jquery/3.4.1/jquery.min.js}" type="text/javascript"></script>
<script>

    let map111 = new Map();

    function getData() {
        downloadData("https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json", "000000");
        console.log(map111.size);
    }

    // getData();

    let adcodeArr = ['000000', '110000', '110101', '110102', '110105', '110106', '110107', '110108', '110109', '110111', '110112', '110113', '110114', '110115', '110116', '110117', '110118', '110119', '120000', '120101', '120102', '120103', '120104', '120105', '120106', '120110', '120111', '120112', '120113', '120114', '120115', '120116', '120117', '120118', '120119', '130000', '130100', '130200', '130300', '130400', '130500', '130600', '130700', '130800', '130900', '131000', '131100', '140000', '140100', '140200', '140300', '140400', '140500', '140600', '140700', '140800', '140900', '141000', '141100', '150000', '150100', '150200', '150300', '150400', '150500', '150600', '150700', '150800', '150900', '152200', '152500', '152900', '210000', '210100', '210200', '210300', '210400', '210500', '210600', '210700', '210800', '210900', '211000', '211100', '211200', '211300', '211400', '220000', '220100', '220200', '220300', '220400', '220500', '220600', '220700', '220800', '222400', '230000', '230100', '230200', '230300', '230400', '230500', '230600', '230700', '230800', '230900', '231000', '231100', '231200', '232700', '310000', '310101', '310104', '310105', '310106', '310107', '310109', '310110', '310112', '310113', '310114', '310115', '310116', '310117', '310118', '310120', '310151', '320000', '320100', '320200', '320300', '320400', '320500', '320600', '320700', '320800', '320900', '321000', '321100', '321200', '321300', '330000', '330100', '330200', '330300', '330400', '330500', '330600', '330700', '330800', '330900', '331000', '331100', '340000', '340100', '340200', '340300', '340400', '340500', '340600', '340700', '340800', '341000', '341100', '341200', '341300', '341500', '341600', '341700', '341800', '350000', '350100', '350200', '350300', '350400', '350500', '350600', '350700', '350800', '350900', '360000', '360100', '360200', '360300', '360400', '360500', '360600', '360700', '360800', '360900', '361000', '361100', '370000', '370100', '370200', '370300', '370400', '370500', '370600', '370700', '370800', '370900', '371000', '371100', '371300', '371400', '371500', '371600', '371700', '410000', '410100', '410200', '410300', '410400', '410500', '410600', '410700', '410800', '410900', '411000', '411100', '411200', '411300', '411400', '411500', '411600', '411700', '419001', '420000', '420100', '420200', '420300', '420500', '420600', '420700', '420800', '420900', '421000', '421100', '421200', '421300', '422800', '429004', '429005', '429006', '429021', '430000', '430100', '430200', '430300', '430400', '430500', '430600', '430700', '430800', '430900', '431000', '431100', '431200', '431300', '433100', '440000', '440100', '440200', '440300', '440400', '440500', '440600', '440700', '440800', '440900', '441200', '441300', '441400', '441500', '441600', '441700', '441800', '441900', '442000', '442101', '445100', '445200', '445300', '450000', '450100', '450200', '450300', '450400', '450500', '450600', '450700', '450800', '450900', '451000', '451100', '451200', '451300', '451400', '460000', '460100', '460200', '460300', '460400', '469001', '469002', '469005', '469006', '469007', '469021', '469022', '469023', '469024', '469025', '469026', '469027', '469028', '469029', '469030', '500000', '500101', '500102', '500103', '500104', '500105', '500106', '500107', '500108', '500109', '500110', '500111', '500112', '500113', '500114', '500115', '500116', '500117', '500118', '500119', '500120', '500151', '500152', '500153', '500154', '500155', '500156', '500229', '500230', '500231', '500233', '500235', '500236', '500237', '500238', '500240', '500241', '500242', '500243', '510000', '510100', '510300', '510400', '510500', '510600', '510700', '510800', '510900', '511000', '511100', '511300', '511400', '511500', '511600', '511700', '511800', '511900', '512000', '513200', '513300', '513400', '520000', '520100', '520200', '520300', '520400', '520500', '520600', '522300', '522600', '522700', '530000', '530100', '530300', '530400', '530500', '530600', '530700', '530800', '530900', '532300', '532500', '532600', '532800', '532900', '533100', '533300', '533400', '540000', '540100', '540200', '540300', '540400', '540500', '540600', '542500', '610000', '610100', '610200', '610300', '610400', '610500', '610600', '610700', '610800', '610900', '611000', '620000', '620100', '620200', '620300', '620400', '620500', '620600', '620700', '620800', '620900', '621000', '621100', '621200', '622900', '623000', '630000', '630100', '630200', '632200', '632300', '632500', '632600', '632700', '632800', '640000', '640100', '640200', '640300', '640400', '640500', '650000', '650100', '650200', '650400', '659010', '652300', '652700', '652800', '652900', '653000', '653100', '653200', '654000', '654200', '654300', '659001', '659002', '659003', '659004', '659005', '659006', '659007', '659008', '659009', '710000', '810000', '810001', '810002', '810003', '810004', '810005', '810006', '810007', '810008', '810009', '810010', '810011', '810012', '810013', '810014', '810015', '810016', '810017', '810018', '820000', '820001', '820002', '820003', '820004', '820005', '820006', '820007', '820008'];
    // let adcodeArr = ['110101', '110102', '110105', '110106', '110107', '110108', '110109', '110111', '110112', '110113', '110114', '110115', '110116', '110117', '110118', '110119', '120101', '120102', '120103', '120104', '120105', '120106', '120110', '120111', '120112', '120113', '120114', '120115', '120116', '120117', '120118', '120119', '130100', '130200', '130300', '130400', '130500', '130600', '130700', '130800', '130900', '131000', '131100', '140100', '140200', '140300', '140400', '140500', '140600', '140700', '140800', '140900', '141000', '141100', '150100', '150200', '150300', '150400', '150500', '150600', '150700', '150800', '150900', '152200', '152500', '152900', '210100', '210200', '210300', '210400', '210500', '210600', '210700', '210800', '210900', '211000', '211100', '211200', '211300', '211400', '220100', '220200', '220300', '220400', '220500', '220600', '220700', '220800', '222400', '230100', '230200', '230300', '230400', '230500', '230600', '230700', '230800', '230900', '231000', '231100', '231200', '232700', '310101', '310104', '310105', '310106', '310107', '310109', '310110', '310112', '310113', '310114', '310115', '310116', '310117', '310118', '310120', '310151', '320100', '320200', '320300', '320400', '320500', '320600', '320700', '320800', '320900', '321000', '321100', '321200', '321300', '330100', '330200', '330300', '330400', '330500', '330600', '330700', '330800', '330900', '331000', '331100', '340100', '340200', '340300', '340400', '340500', '340600', '340700', '340800', '341000', '341100', '341200', '341300', '341500', '341600', '341700', '341800', '350100', '350200', '350300', '350400', '350500', '350600', '350700', '350800', '350900', '360100', '360200', '360300', '360400', '360500', '360600', '360700', '360800', '360900', '361000', '361100', '370100', '370200', '370300', '370400', '370500', '370600', '370700', '370800', '370900', '371000', '371100', '371300', '371400', '371500', '371600', '371700', '410100', '410200', '410300', '410400', '410500', '410600', '410700', '410800', '410900', '411000', '411100', '411200', '411300', '411400', '411500', '411600', '411700', '419001', '420100', '420200', '420300', '420500', '420600', '420700', '420800', '420900', '421000', '421100', '421200', '421300', '422800', '429004', '429005', '429006', '429021', '430100', '430200', '430300', '430400', '430500', '430600', '430700', '430800', '430900', '431000', '431100', '431200', '431300', '433100', '440100', '440200', '440300', '440400', '440500', '440600', '440700', '440800', '440900', '441200', '441300', '441400', '441500', '441600', '441700', '441800', '441900', '442000', '442101', '445100', '445200', '445300', '450100', '450200', '450300', '450400', '450500', '450600', '450700', '450800', '450900', '451000', '451100', '451200', '451300', '451400', '460100', '460200', '460300', '460400', '469001', '469002', '469005', '469006', '469007', '469021', '469022', '469023', '469024', '469025', '469026', '469027', '469028', '469029', '469030', '500101', '500102', '500103', '500104', '500105', '500106', '500107', '500108', '500109', '500110', '500111', '500112', '500113', '500114', '500115', '500116', '500117', '500118', '500119', '500120', '500151', '500152', '500153', '500154', '500155', '500156', '500229', '500230', '500231', '500233', '500235', '500236', '500237', '500238', '500240', '500241', '500242', '500243', '510100', '510300', '510400', '510500', '510600', '510700', '510800', '510900', '511000', '511100', '511300', '511400', '511500', '511600', '511700', '511800', '511900', '512000', '513200', '513300', '513400', '520100', '520200', '520300', '520400', '520500', '520600', '522300', '522600', '522700', '530100', '530300', '530400', '530500', '530600', '530700', '530800', '530900', '532300', '532500', '532600', '532800', '532900', '533100', '533300', '533400', '540100', '540200', '540300', '540400', '540500', '540600', '542500', '610100', '610200', '610300', '610400', '610500', '610600', '610700', '610800', '610900', '611000', '620100', '620200', '620300', '620400', '620500', '620600', '620700', '620800', '620900', '621000', '621100', '621200', '622900', '623000', '630100', '630200', '632200', '632300', '632500', '632600', '632700', '632800', '640100', '640200', '640300', '640400', '640500', '650100', '650200', '650400', '659010', '652300', '652700', '652800', '652900', '653000', '653100', '653200', '654000', '654200', '654300', '659001', '659002', '659003', '659004', '659005', '659006', '659007', '659008', '659009', '810001', '810002', '810003', '810004', '810005', '810006', '810007', '810008', '810009', '810010', '810011', '810012', '810013', '810014', '810015', '810016', '810017', '810018', '820001', '820002', '820003', '820004', '820005', '820006', '820007', '820008'];

    $.each(adcodeArr, function (i, adcode) {
        url = "https://geo.datav.aliyun.com/areas_v3/bound/"+ adcode +".json";
        $.ajax({
            url: url,
            type: 'get',
            dataType: 'json',
            async: false
        }).done(function (data) {
            //download(adcode, JSON.stringify(data));
            $.each(data.features, function (i, country) {
                let adcode = JSON.stringify(country.properties.adcode);
                let level = country.properties.level;
                let lngLats = [];
                let coordinates = country.geometry.coordinates;
                $.each(coordinates, function (i, coordinate) {
                    $.each(coordinate, function (i, points) {
                        if (points.length == 2) {
                            lngLats.push(points);
                        } else {
                            $.each(points, function (i, point) {
                                lngLats.push(point);
                            });
                        }
                    });
                });
                let xy = getPolygonAreaCenter(lngLats);
                let points = calculateScope(lngLats);
                let zoom = calculateZoom(points[0], points[1]);
                console.log( "\"" + country.properties.adcode + "\": {\"zoom\": \"" + zoom + "\", \"center\": [" + xy.lng + ", " + xy.lat + ", \"name\": \"" + country.properties.name + "\", \"level\": \"" + level +"\"]}, " )
            });
        });
    });

    function downloadData(url, districtCode) {
        if (map111.get(districtCode) || districtCode == '100000_JD') {
            return;
        }
        $.ajax({
            url: url,
            type: 'get',
            dataType: 'json',
            async: false
        }).done(function (data) {
            map111.set(districtCode, districtCode);
            // download(districtCode, JSON.stringify(data));
            $.each(data.features, function (i, country) {
                let adcode = JSON.stringify(country.properties.adcode);
                let level = country.properties.level;
                let lngLats = [];
                let coordinates = country.geometry.coordinates;
                $.each(coordinates, function (i, coordinate) {
                    $.each(coordinate, function (i, points) {
                        if (points.length == 2) {
                            lngLats.push(points);
                        } else {
                            $.each(points, function (i, point) {
                                lngLats.push(point);
                            });
                        }
                    });
                });
                let xy = getPolygonAreaCenter(lngLats);
                console.log( "\"" + country.properties.adcode + "\": {\"name\": \"" + country.properties.name + ", \"level\": \"" + level +"\", \"center\": [" + xy.lng + ", " + xy.lat + "]}, " )

                if (level == 'city') {
                    url = "https://geo.datav.aliyun.com/areas_v3/bound/" + adcode + ".json";
                    downloadData(url, adcode);
                } else if (level == 'province'){
                    url = "https://geo.datav.aliyun.com/areas_v3/bound/" + adcode + "_full.json";
                    downloadData(url, adcode);
                }
            });
        }).fail(function (data) {
            if (data.status == '404') {
                url = "https://geo.datav.aliyun.com/areas_v3/bound/" + districtCode + ".json";
                // downloadData(url, districtCode);
            }
        });
    }

    function download(filename, text) {
        let pom = document.createElement('a');
        pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        pom.setAttribute('download', filename);
        if (document.createEvent) {
            let event = document.createEvent('MouseEvents');
            event.initEvent('click', true, true);
            pom.dispatchEvent(event);
        } else {
            pom.click();
        }
    }

    /*计算三角形的面积*/
    function Area(p0, p1, p2) {
        let area = 0.0;
        area = p0[1] * p1[0] + p1[1] * p2[0] + p2[1] * p0[0] - p1[1] * p0[0] - p2[1] * p1[0] - p0[1] * p2[0];
        return area / 2;
    }

    // 计算polygon的质心
    function getPolygonAreaCenter(points) {
        let xy = {};
        let sum_x = 0;
        let sum_y = 0;
        let sum_area = 0;
        let p1 = points[1];
        //debugger;
        for (let i = 2; i < points.length; i++) {
            p2 = points[i];
            area = Area(points[0], p1, p2);
            sum_area += area;
            sum_x += (points[0][1] + p1[1] + p2[1]) * area;
            sum_y += (points[0][0] + p1[0] + p2[0]) * area;
            p1 = p2;
        }
        let xx = sum_x / sum_area / 3;
        let yy = sum_y / sum_area / 3;
        xy.lat = xx.toFixed(5);
        xy.lng = yy.toFixed(5);
        return xy;
    }
    // $.getJSON("static/center.json", function (data) {
    //    console.log(JSON.stringify(data.adcode110000));
    // });

</script>

</body>
</html>